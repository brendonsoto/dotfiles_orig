" Use Vim settings, rather then Vi settings (much better!).
" This must be first, because it changes other options as a side effect.
set nocompatible


"""""""""""""""""""""
"		Plugins
"""""""""""""""""""""

" Vim-Plug - Manage Plugins
call plug#begin('~/.vim/plugged')

" Colors!!
Plug 'liuchengxu/space-vim-dark'
Plug 'morhetz/gruvbox'
Plug 'fenetikm/falcon'
Plug 'joshdick/onedark.vim'

" CSS
Plug 'hail2u/vim-css3-syntax', { 'for': ['css', 'html', 'javascript', 'javascript.jsx'] }

" External plugin support
Plug '/usr/local/opt/fzf'
Plug 'junegunn/fzf.vim'

" Multi-lang
Plug 'autozimu/LanguageClient-neovim', {
  \ 'for': ['javascript', 'javascript.jsx', 'haskell'],
  \ 'branch': 'next',
  \ 'do': 'bash install.sh'
  \}
Plug 'godlygeek/tabular', { 'for': ['haskell', 'javascript', 'javascript.jsx'] }
Plug 'tpope/vim-dispatch', { 'for': ['haskell', 'javascript', 'javascript.jsx'] }
Plug 'w0rp/ale', { 'for': ['haskell', 'javascript', 'javascript.jsx'] }

" Elm
Plug 'ElmCast/elm-vim', { 'for': 'elm' }

" Haskell
Plug 'neovimhaskell/haskell-vim', { 'for': 'haskell' }

" Javascript & related
Plug 'elzr/vim-json', { 'for': ['json', 'javascript'] }
Plug 'mxw/vim-jsx', { 'for': ['HTML', 'javascript', 'javascript.jsx'] }
Plug 'pangloss/vim-javascript', { 'for': ['HTML', 'javascript', 'javascript.jsx', 'typescript'] }

" Markdown
Plug 'junegunn/goyo.vim', { 'for': ['markdown', 'vimwiki'] }

" Web general
Plug 'mattn/emmet-vim', { 'for': ['HTML', 'javascript', 'javascript.jsx'] }
Plug 'tmhedberg/matchit', { 'for': ['HTML', 'javascript', 'javascript.jsx'] }

" Vim general
Plug 'Shougo/deoplete.nvim', { 'do': ':UpdateRemotePlugins' }
" Plug 'SirVer/ultisnips'
Plug 'easymotion/vim-easymotion'
Plug 'fholgado/minibufexpl.vim'
Plug 'francoiscabrol/ranger.vim'
Plug 'itchyny/lightline.vim'
Plug 'jiangmiao/auto-pairs'
Plug 'junegunn/rainbow_parentheses.vim'
Plug 'tomtom/tcomment_vim'
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-surround'
Plug 'tpope/vim-unimpaired'
Plug 'vimwiki/vimwiki'

call plug#end()


"""""""""""""""""""""
"		General Settings
"""""""""""""""""""""

" color "
set termguicolors
if (has("nvim"))
  "For Neovim 0.1.3 and 0.1.4 < https://github.com/neovim/neovim/pull/2198 >
  let $NVIM_TUI_ENABLE_TRUE_COLOR=1
endif

filetype plugin indent on " Enable file detection and load any plugins for them

" Colorscheme
syntax enable
" Gruvbox specifics
" let g:gruvbox_italic=1
" modified search based off of gruvbox for readability
" hi Search cterm=inverse ctermfg=143 ctermbg=234 gui=bold guifg=#1d2021 guibg=#b8bb26
colorscheme onedark

set autoindent " allow autoindent by default
set background=dark
set backspace=indent,eol,start " allow backspacing over everything in insert mode
set clipboard+=unnamedplus
set diffopt=filler,vertical " Diff settings
set expandtab " maintains # of spaces for a tab in insert mode
set hidden " don't have to write before opening new buffer
set history=50 " command line history
set hlsearch " highlight search terms
set ignorecase " ignore case when searching
set inccommand=split " show changes in a split window for search and replace
set incsearch " show matches as you type
set linebreak " enable word-break without inserting an EOL character
set nobackup " no backups
set noswapfile " no backups
set number " display line number
set omnifunc=syntaxcomplete#Complete " Enable omnicompletion
set path=$PWD/** " Find from current directory
set ruler " show the cursor position all the time
set shiftwidth=2 " spaces for auto indent
set showcmd " display incomplete commands
set showmatch " show matching parenthesis
set smartcase " search is case-insensitive when keyword is all lowercase
set tabstop=2 " set tab to 2 spaces
set undodir=$HOME/.vim/undo " undo file for work
set undofile " Save undo's after file closes
set undolevels=1000 " How many undos
set undoreload=1000 " How many lines to save for undo

" enable mouse for scrolling
if has("mouse")
	set mouse=a
endif


"""""""""""""""""""""
"		Mappings
"""""""""""""""""""""

" MapLeader
let mapleader = "\<Space>"

" Easy open file from vim
map <silent> <F12> :!open %<CR>

" Easy open, close, and save
nnoremap <Leader>e :e<Space>
nnoremap <Leader>v :vs
nnoremap <Leader>Q :qa<CR>
nnoremap <Leader>w :w<CR>
nnoremap <Leader>q :q<CR>

" Easy window Navigation
nnoremap <Leader>h <C-w>h
nnoremap <Leader>j <C-w>j
nnoremap <Leader>k <C-w>k
nnoremap <Leader>l <C-w>l

" Easy copy & paste
map <Leader>y "+y
map <Leader>p "+p
map <Leader>Y ggv<S-g>$"*y

" Move line by line even when the line is wrapped
map j gj
map k gk

" Buffer switching
nnoremap <Leader>] :bn<CR>
nnoremap <Leader>[ :bp<CR>

" Remove trailing whitespace
nmap <Leader>W :%s/ \+$//<CR>

" miniBufExplr
nnoremap <Leader>b :MBEToggle<CR>

" Easy window splitting
map <Leader>s :split<CR>
map <Leader>= <C-w>=

" Easy tabs
map <Leader>t :tab split<CR>

" Easy remove highlighting
map <Leader>/ :nohl<CR>

" Easy diffupdate
nnoremap du :diffupdate<CR>

" Easy search for visually selected text
vnoremap // y/<C-R>"<CR>


"""""""""""""""""""""
"		Autocommands
"""""""""""""""""""""

" Enable auto sourcing vimrc on save
autocmd! bufwritepost .vimrc source %
autocmd! bufwritepost vimrc source %

" Disable auto commenting
autocmd FileType * setlocal formatoptions-=c formatoptions-=r formatoptions-=o

" Jump to last known position in a file after opening
:au BufReadPost *
 \ if line("'\"") > 1 && line("'\"") <= line("$") && &ft !~# 'commit'
 \ |   exe "normal! g`\""
 \ | endif

" Highlight TODO, FIXME, NOTE
autocmd Syntax * call matchadd('todo', '\W\zs\(TODO\|FIXME\|XXX\)')
autocmd Syntax * call matchadd('Debug', '\W\zs\(NOTE\)')

function! OnTermClose()
    " Try to move the cursor to the last line containing text
    try
        $;?.
    catch
        " The buffer is empty here. This shouldn't ever happen
        return
    endtry
    " Is the last line an error message?
    if match(getline('.'), 'make: \*\*\* \[[^\]]\+] Error ') == -1
        call feedkeys('a ')
    endif
endfunction

augroup MY_TERM_AUGROUP
    autocmd!
    au TermClose * silent call OnTermClose()
augroup END


"""""""""""""""""""""
"		Language specific stuff
"""""""""""""""""""""

" Set .Xmonad-related files to use Haskell syntax highlighting
autocmd BufRead,BufNewFile .xmobarrc set filetype=haskell

" Set JSON-like files to use json syntax highlighting
autocmd BufRead,BufNewFile *.json,.eslintrc,.babelrc set filetype=json

" Javascript / JSX
autocmd FileType javascript,javascript.jsx let b:dispatch = 'npx jest % --colors'

" JSX
let g:jsx_ext_required = 0

" SQL -- Reset the Omni Key so I can use CTRL-[ to exit insert mode
let g:ftplugin_sql_omni_key = '<C-j>'


"""""""""""""""""""""
"		Tools
"""""""""""""""""""""

" Ale
let g_ale_completion_enabled = 1
let g:ale_linters = {
  \ 'javascript': ['eslint'],
  \}
nmap <silent> [j <Plug>(ale_previous_wrap)
nmap <silent> ]j <Plug>(ale_next_wrap)
nmap <Leader>? <Plug>(ale_detail)

" Deoplete
let g:deoplete#enable_at_startup = 1
call deoplete#custom#option('smart_case', v:true)

" Dispatch
nmap <Leader>D :Dispatch<CR>

" Emmet
let g:user_emmet_settings = {
  \'javascript.jsx': {
  \   'extends': 'jsx'
  \}
  \}

" Fugitive - auto-clean fugitive buffers
autocmd BufReadPost fugitive://* set bufhidden=delete

" FZF
nnoremap <Leader>a :Rg<CR>
nnoremap <C-p> :Files<CR>

" Lightline
set laststatus=2
let g:lightline = {
  \ 'active': {
  \   'right':  [ [ 'lineinfo' ],
  \               [ 'percent' ] ],
  \   'left': [ [ 'mode', 'paste', 'relativepath' ],
  \             [ 'fugitive', 'readonly', 'modified' ] ]
  \ },
  \ 'colorscheme': 'one',
  \ 'component_function': {
  \   'fugitive': 'LightLineFugitive',
  \   'readonly': 'LightLineReadonly',
  \   'modified': 'LightLineModified'
  \ }
  \ }

function! LightLineModified()
  if &filetype == "help"
    return ""
  elseif &modified
    return "+"
  elseif &modifiable
    return ""
  else
    return ""
  endif
endfunction

function! LightLineReadonly()
  if &filetype == "help"
    return ""
  elseif &readonly
    return "тнд"
  else
    return ""
  endif
endfunction

function! LightLineFugitive()
  return exists('*fugitive#head') ? fugitive#head() : ''
endfunction

" LSP - LanguageServerProtocol, not LumpySpacePrincess
" kudos to https://fortes.com/2017/language-server-neovim/
let g:LanguageClient_autoStart = 1
let g:LanguageClient_loggingFile = '/tmp/langClient.log'
let g:LanguageClient_loggingLevel = 'ERROR'
let g:LanguageClient_serverStderr = '/tmp/langClient_serverErr.log'
let g:LanguageClient_serverCommands = {}

" JS/TS detection
if executable('javascript-typescript-stdio')
  let g:LanguageClient_serverCommands['javascript'] = ['javascript-typescript-stdio']
  let g:LanguageClient_serverCommands['javascript.jsx'] = ['javascript-typescript-stdio']
  autocmd FileType javascript setlocal completefunc=LanguageClient#complete
  autocmd FileType javascript.jsx setlocal completefunc=LanguageClient#complete
endif

" Haskell detection -- NOTE Disabling for now since it uses up WAY too much cpu power
if executable('hie')
  let g:LanguageClient_serverCommands['haskell'] = ['hie-wrapper']
endif

function SetLSPShortcuts()
  nnoremap <leader>ld :call LanguageClient#textDocument_definition()<CR>
  nnoremap <leader>lr :call LanguageClient#textDocument_rename()<CR>
  nnoremap <leader>lf :call LanguageClient#textDocument_formatting()<CR>
  nnoremap <leader>lt :call LanguageClient#textDocument_typeDefinition()<CR>
  nnoremap <leader>lx :call LanguageClient#textDocument_references()<CR>
  nnoremap <leader>la :call LanguageClient_workspace_applyEdit()<CR>
  nnoremap <leader>lc :call LanguageClient#textDocument_completion()<CR>
  nnoremap <leader>lh :call LanguageClient#textDocument_hover()<CR>
  nnoremap <leader>ls :call LanguageClient_textDocument_documentSymbol()<CR>
  nnoremap <leader>lm :call LanguageClient_contextMenu()<CR>
endfunction()

augroup LSP
  autocmd!
  autocmd FileType javascript,javascript.jsx call SetLSPShortcuts()
augroup END

" Rainbow Parenthesis
" Set Rainbow Parenthesis to always be active
augroup rainbow
  autocmd!
  autocmd FileType c,cpp,java,javascript,javascript.jsx,json,php,python,ruby,sql RainbowParentheses
augroup END
let g:rainbow#pairs = [['(', ')'], ['[', ']'], ['{', '}']]

" Ranger
let g:ranger_command_override = 'ranger --cmd "set show_hidden=true"'
let g:ranger_replace_netrw = 1

" Tabular
nmap <Leader>T= :Tabularize /=<CR>
vmap <Leader>T= :Tabularize /=<CR>
nmap <Leader>T: :Tabularize /:\zs<CR>
vmap <Leader>T: :Tabularize /:\zs<CR>

" " UltiSnips
" let g:UltiSnipsSnippetsDir='~/.vim/ultiSnips'
" let g:UltiSnipsSnippetsDirectories=['~/.vim/ultiSnips']
" let g:UltiSnipsExpandTrigger='<c-e>'

" Vimwiki
let g:vimwiki_list = [
  \ {'path': '~/vimwiki'},
  \ {'path': '~/dotfiles/my_wiki'}
  \]
nmap <Leader>wn <Plug>VimwikiNextLink
nmap <Leader>wp <Plug>VimwikiPrevLink
nmap <Leader>x <Plug>VimwikiToggleListItem
